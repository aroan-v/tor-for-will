<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Poll</title>
  </head>
  <body>
    <!-- Counter display -->
    <div id="counter">Votes Sent: 0</div>
    <!-- Manual Start Button -->
    <button id="startBtn">Start Voting</button>

    <!-- PollDaddy script embed -->
    <script
      type="text/javascript"
      charset="utf-8"
      src="https://secure.polldaddy.com/p/15909793.js"
    ></script>

    <script>
      // Sleep helper
      const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));
      const randomDelay = (min, max) =>
        Math.floor(Math.random() * (max - min + 1)) + min;

      // Logger
      function log(msg) {
        console.log(msg);
      }

      // Counter
      let voteCount = 0;
      const counterEl = document.getElementById("counter");
      function updateCounter() {
        counterEl.textContent = "Votes Sent: " + voteCount;
      }

      // Handle return link reset
      async function handleReturnLinkReset() {
        try {
          log("üîé Looking for return link...");
          const returnLink = document.querySelector("a.pds-return-poll");

          if (returnLink) {
            // small pause
            await sleep(randomDelay(1500, 3000));
            returnLink.click();
            log("üîÑ Clicked return link ‚Üí back to poll");

            // wait for main elements to come back
            let retries = 0;
            while (
              !document.querySelector(
                "input#PDI_answer70048651.css-radiobutton.pds-radiobutton, #pd-vote-button15909793",
              ) &&
              retries < 10
            ) {
              await sleep(1000);
              retries++;
            }

            if (retries >= 10) {
              log(
                "‚ö†Ô∏è Main poll elements didn‚Äôt reappear, doing full page reload",
              );
              location.reload();
            }
          } else {
            log("‚ö†Ô∏è Return link not found ‚Üí reloading page");
            location.reload();
          }
        } catch (err) {
          console.error("‚ö†Ô∏è Error handling return link:", err);
          location.reload();
        }
      }

      // Voting loop
      async function startVotingLoop() {
        while (true) {
          try {
            const candidates = {
              will: "70048651",
              emilio: "70048652",
            };

            const targetCandidate = "will"; // <-- change this to pick candidate
            const candidateSelector = `input#PDI_answer${candidates[targetCandidate]}.css-radiobutton.pds-radiobutton`;

            // find elements
            const radioBtn = document.querySelector(candidateSelector);
            const voteBtn = document.querySelector("#pd-vote-button15909793");

            // If missing ‚Üí handle return link reset
            if (!radioBtn || !voteBtn) {
              log(
                "‚ö†Ô∏è Required elements not found ‚Üí attempting return link reset...",
              );
              await handleReturnLinkReset();
              continue;
            }

            // Check radio
            if (!radioBtn.checked) {
              log("üîò Radio button not checked ‚Üí checking it now");
              radioBtn.checked = true;
              radioBtn.dispatchEvent(new Event("change", { bubbles: true }));
              await sleep(Math.random() * 500 + 500);
            } else {
              log("‚úÖ Radio button already checked");
            }

            // Click vote button
            voteBtn.click();
            voteCount++;
            updateCounter();
            log("üó≥Ô∏è Vote button clicked, total votes: " + voteCount);
            await sleep(Math.random() * 500 + 800);

            // idle delay before next iteration
            await sleep(randomDelay(2000, 4000));
          } catch (err) {
            log("‚ö†Ô∏è Error during automation loop, retrying in 5s");
            console.error(err);
            await sleep(5000);
          }
        }
      }

      // Hook button
      document.getElementById("startBtn").addEventListener("click", () => {
        log("üîò Start button clicked ‚Äî launching voting loop");
        startVotingLoop();
      });
    </script>
  </body>
</html>
