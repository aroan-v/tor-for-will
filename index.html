<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Poll</title>
    <style>
      #startBtn {
        position: fixed;
        top: 10px;
        left: 10px;
        z-index: 9999;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
      }
      #counter {
        position: fixed;
        top: 10px;
        left: 150px;
        z-index: 9999;
        font-size: 16px;
        background: white;
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 6px;
      }
    </style>
  </head>
  <body>
    <!-- Hardcoded start button -->
    <button id="startBtn">‚ñ∂Ô∏è Start Voting</button>
    <!-- Vote counter -->
    <div id="counter">Votes Sent: 0</div>

    <!-- Poll embed -->
    <div id="poll-container">
      <script
        type="text/javascript"
        charset="utf-8"
        src="https://secure.polldaddy.com/p/15909793.js"
      ></script>
    </div>

    <script>
      // Sleep helper
      const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));
      const randomDelay = (min, max) =>
        Math.floor(Math.random() * (max - min + 1)) + min;

      // Logger
      function log(msg) {
        console.log(msg);
      }

      // Counter
      let voteCount = 0;
      const counterEl = document.getElementById("counter");
      function updateCounter() {
        counterEl.textContent = "Votes Sent: " + voteCount;
      }

      // Reload poll script
      async function reloadPoll() {
        log("üîÑ Reloading poll...");
        const pollContainer = document.getElementById("poll-container");
        pollContainer.innerHTML = ""; // clear old
        const script = document.createElement("script");
        script.src = "https://secure.polldaddy.com/p/15909793.js";
        script.charset = "utf-8";
        pollContainer.appendChild(script);
        // give it a short time to re-render
        await sleep(2000);
      }

      // Voting loop
      async function startVotingLoop() {
        while (true) {
          try {
            const candidates = {
              will: "70048651",
              emilio: "70048652",
            };

            const targetCandidate = "emilio"; // <-- change this to pick candidate
            const candidateSelector = `input#PDI_answer${candidates[targetCandidate]}.css-radiobutton.pds-radiobutton`;

            // find elements
            const radioBtn = document.querySelector(candidateSelector);
            const voteBtn = document.querySelector("#pd-vote-button15909793");

            // If either element missing ‚Üí reload poll instead of waiting
            if (!radioBtn || !voteBtn) {
              log("‚ö†Ô∏è Required elements not found ‚Üí reloading poll...");
              await reloadPoll();
              continue;
            }

            // Check radio
            if (!radioBtn.checked) {
              log("üîò Radio button not checked ‚Üí checking it now");
              radioBtn.checked = true;
              radioBtn.dispatchEvent(new Event("change", { bubbles: true }));
              await sleep(Math.random() * 500 + 500);
            } else {
              log("‚úÖ Radio button already checked");
            }

            // Click vote button
            voteBtn.click();
            voteCount++;
            updateCounter();
            log("üó≥Ô∏è Vote button clicked, total votes: " + voteCount);
            await sleep(Math.random() * 500 + 800);

            // For demo: wait a random time before next attempt
            await sleep(randomDelay(2000, 4000));
          } catch (err) {
            log("‚ö†Ô∏è Error during automation loop, retrying in 5s");
            console.error(err);
            await sleep(5000);
          }
        }
      }

      // Hook button
      document.getElementById("startBtn").addEventListener("click", () => {
        log("üîò Start button clicked ‚Äî launching voting loop");
        startVotingLoop();
      });
    </script>
  </body>
</html>
